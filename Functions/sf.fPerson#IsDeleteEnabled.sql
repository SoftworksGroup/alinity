SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [sf].[fPerson#IsDeleteEnabled]
	(
	@PersonSID int
	)
returns bit
as
/*********************************************************************************************************************************
ScalarF : sf.fPerson#IsDeleteEnabled
Notice  : Copyright Â© 2018 Softworks Group Inc.
Summary : Returns 1 (bit) when deletion of the record is allowed
-----------------------------------------------------------------------------------------------------------------------------------
Author  : Generated by DB Studio: pIsDeleteEnabledFcnGen | Designer: Tim Edlund
Version : May 2018
-----------------------------------------------------------------------------------------------------------------------------------
Comments
--------

The function is called by the entity view to set a calculated bit column "IsDeleteEnabled". The column is typically bound to a
delete button on the UI.  The results of the function determine whether or not deletion should be allowed.  The function tests
one or more of the following factors: 1) whether the table contains a system code column in which case deletion is
not allowed, 2) the security granted to the logged in user, and, 3) the existence of child records.

When a child table is related through a foreign key with cascade delete, and all descendants of that table are also related with
cascade delete constraints, then the child table is not considered blocking and will not appear in the SELECT statement.

Table-specific logic can be added through tagged sections (pre and post check). An extended version of the function is not
supported.  Code implemented within code tags is part of the base product and applies to all client configurations.

Example
-------

select top (10)
   x.PersonSID
  ,sf.fPerson#IsDeleteEnabled(x.PersonSID) IsDeleteEnabled
from
  sf.Person x
order by
  newid()

-------------------------------------------------------------------------------------------------------------------------------- */

begin

	declare
		 @isDeleteEnabled                 bit																	-- return value
		,@ON                              bit = cast(1 as bit)								-- constant to eliminate repetitive casting syntax
		,@OFF                             bit = cast(0 as bit)								-- constant to eliminate repetitive casting syntax
	
	set @isDeleteEnabled = @ON																							-- set return value to ON then check for blocking conditions
	
	--! <PreCheck>
	--  insert pre-check logic here ...
	--! </PreCheck>
	
	if @isDeleteEnabled = @ON																								-- check for existence of child records
	begin
	
		if
		(
			select
				  count(x01.InvoiceSID)
				+ count(x02.OrgContactSID)
				+ count(x03.PAPSubscriptionSID)
				+ count(x04.PaymentSID)
				+ count(x05.PersonDocSID)
				+ count(x06.PersonMailingAddressSID)
				+ count(x07.PersonNoteSID)
				+ count(x08.ProfileUpdateSID)
				+ count(x09.RegistrantSID)
				+ count(x10.RegistrantAppReviewSID)
				+ count(x11.RegistrantAuditReviewSID)
				+ count(x12.ApplicationUserSID)
				+ count(x13.PersonEmailAddressSID)
				+ count(x14.PersonEmailMessageSID)
				+ count(x15.PersonGroupMemberSID)
				+ count(x16.PersonMailingPreferenceSID)
				+ count(x17.PersonOtherNameSID)
				+ count(x18.PersonTextMessageSID)
				+ count(x19.PersonProfileSID)
			from
				sf.Person                  x00
			left outer join
				  (select top (1) x.InvoiceSID, x.PersonSID from dbo.Invoice x where x.PersonSID = @PersonSID) x01 on x00.PersonSID =  x01.PersonSID
			left outer join
				  (select top (1) x.OrgContactSID, x.PersonSID from dbo.OrgContact x where x.PersonSID = @PersonSID) x02 on x00.PersonSID =  x02.PersonSID
			left outer join
				  (select top (1) x.PAPSubscriptionSID, x.PersonSID from dbo.PAPSubscription x where x.PersonSID = @PersonSID) x03 on x00.PersonSID =  x03.PersonSID
			left outer join
				  (select top (1) x.PaymentSID, x.PersonSID from dbo.Payment x where x.PersonSID = @PersonSID) x04 on x00.PersonSID =  x04.PersonSID
			left outer join
				  (select top (1) x.PersonDocSID, x.PersonSID from dbo.PersonDoc x where x.PersonSID = @PersonSID) x05 on x00.PersonSID =  x05.PersonSID
			left outer join
				  (select top (1) x.PersonMailingAddressSID, x.PersonSID from dbo.PersonMailingAddress x where x.PersonSID = @PersonSID) x06 on x00.PersonSID =  x06.PersonSID
			left outer join
				  (select top (1) x.PersonNoteSID, x.PersonSID from dbo.PersonNote x where x.PersonSID = @PersonSID) x07 on x00.PersonSID =  x07.PersonSID
			left outer join
				  (select top (1) x.ProfileUpdateSID, x.PersonSID from dbo.ProfileUpdate x where x.PersonSID = @PersonSID) x08 on x00.PersonSID =  x08.PersonSID
			left outer join
				  (select top (1) x.RegistrantSID, x.PersonSID from dbo.Registrant x where x.PersonSID = @PersonSID) x09 on x00.PersonSID =  x09.PersonSID
			left outer join
				  (select top (1) x.RegistrantAppReviewSID, x.PersonSID from dbo.RegistrantAppReview x where x.PersonSID = @PersonSID) x10 on x00.PersonSID =  x10.PersonSID
			left outer join
				  (select top (1) x.RegistrantAuditReviewSID, x.PersonSID from dbo.RegistrantAuditReview x where x.PersonSID = @PersonSID) x11 on x00.PersonSID =  x11.PersonSID
			left outer join
				  (select top (1) x.ApplicationUserSID, x.PersonSID from sf.ApplicationUser x where x.PersonSID = @PersonSID) x12 on x00.PersonSID =  x12.PersonSID
			left outer join
				  (select top (1) x.PersonEmailAddressSID, x.PersonSID from sf.PersonEmailAddress x where x.PersonSID = @PersonSID) x13 on x00.PersonSID =  x13.PersonSID
			left outer join
				  (select top (1) x.PersonEmailMessageSID, x.PersonSID from sf.PersonEmailMessage x where x.PersonSID = @PersonSID) x14 on x00.PersonSID =  x14.PersonSID
			left outer join
				  (select top (1) x.PersonGroupMemberSID, x.PersonSID from sf.PersonGroupMember x where x.PersonSID = @PersonSID) x15 on x00.PersonSID =  x15.PersonSID
			left outer join
				  (select top (1) x.PersonMailingPreferenceSID, x.PersonSID from sf.PersonMailingPreference x where x.PersonSID = @PersonSID) x16 on x00.PersonSID =  x16.PersonSID
			left outer join
				  (select top (1) x.PersonOtherNameSID, x.PersonSID from sf.PersonOtherName x where x.PersonSID = @PersonSID) x17 on x00.PersonSID =  x17.PersonSID
			left outer join
				  (select top (1) x.PersonTextMessageSID, x.PersonSID from sf.PersonTextMessage x where x.PersonSID = @PersonSID) x18 on x00.PersonSID =  x18.PersonSID
			left outer join
				  (select top (1) x.PersonProfileSID, x.PersonSID from stg.PersonProfile x where isnull(x.PersonSID, -1) = @PersonSID) x19 on x00.PersonSID =  x19.PersonSID
			where
				x00.PersonSID = @PersonSID
		) > 0 set @isDeleteEnabled = @OFF
		
	end
	
	--! <PostCheck>
	if @isDeleteEnabled = @ON																								-- block unless current user inserted the row or is an administrator
	begin
	
		if
		(
			select
				x.CreateUser
			from
				sf.Person x
			where
				x.PersonSID = @PersonSID
			) <> sf.fApplicationUserSession#UserName() set @isDeleteEnabled = sf.fIsGranted('ADMIN.BASE')
	
	end
	--! </PostCheck>
	
	return(@isDeleteEnabled)
end

GO
